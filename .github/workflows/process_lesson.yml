name: Process Lesson Translation

on:
  workflow_dispatch:
    inputs:
      chapter_folder:
        description: 'Select the Chapter Folder'
        required: true
        type: choice
        options:
          - 06_Shataka_Padyalu
          - 07_Sankranthi_Sandesham
          - 08_Kanuvippu
          - 09_Ramappa
          - 10_Shibi_Chakravarti

jobs:
  translate_lesson:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install google-genai

      - name: Run Translation Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          from google import genai
          from google.genai import types

          # Configuration
          MODEL_CHAIN = [
              "gemini-2.0-flash",        # Currently standard high-speed model
              "gemini-flash-latest",     # Backup
              "gemini-1.5-flash",        # Stable backup
              "gemini-1.5-flash-8b"      # High-quota fallback
          ]
          
          chapter = "${{ github.event.inputs.chapter_folder }}"
          md_path = f"class5/{chapter}/lesson.md"
          html_path = f"class5/{chapter}/lesson.html"
          api_key = os.environ.get("GEMINI_API_KEY")

          if not os.path.exists(md_path):
              print(f"‚ùå Error: {md_path} not found.")
              sys.exit(1)

          with open(md_path, "r", encoding="utf-8") as f:
              lesson_content = f.read()

          client = genai.Client(api_key=api_key)
          
          prompt = f"""
          You are a Telugu language tutor. Convert the following Telugu lesson text into a structured learning table.
          
          TASK:
          1. For every sentence in the text, first provide a row with the full sentence in bold.
          2. Then, for every individual word in that sentence, provide a row with the word, its English pronunciation, and its English meaning.
          
          FORMAT:
          Return ONLY a valid HTML snippet containing a table with these columns:
          | Telugu | Pronunciation | Meaning |
          
          Use Bootstrap classes for styling: <table class="table table-striped table-bordered mt-3">
          
          TEXT TO PROCESS:
          {lesson_content}
          """

          success = False
          for model_name in MODEL_CHAIN:
              try:
                  print(f"üîÑ Attempting with model: {model_name}...")
                  response = client.models.generate_content(
                      model=model_name,
                      contents=prompt
                  )
                  
                  output_html = response.text
                  
                  # Clean Markdown artifacts
                  if "```html" in output_html:
                      output_html = output_html.split("```html")[1].split("```")[0]
                  elif "```" in output_html:
                      output_html = output_html.split("```")[1].split("```")[0]

                  final_code = f"""
          <div class="container mt-4">
              <h2 class="mb-4">Lesson Translation: {chapter.replace('_', ' ')}</h2>
              {output_html.strip()}
          </div>
          """
                  with open(html_path, "w", encoding="utf-8") as f:
                      f.write(final_code)
                  
                  print(f"‚úÖ Successfully updated {html_path} using {model_name}")
                  success = True
                  break
              except Exception as e:
                  print(f"‚ö†Ô∏è Model {model_name} failed. Error: {e}")
                  continue

          if not success:
              print("üî• All models in the chain failed or reached quota limits.")
              sys.exit(1)
          EOF

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update lesson.html for ${{ github.event.inputs.chapter_folder }} using fallback chain"
          git push
