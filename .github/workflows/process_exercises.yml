name: Process Exercise Generation

on:
  workflow_dispatch:
    inputs:
      chapter_folder:
        description: 'Select the Chapter Folder'
        required: true
        type: choice
        options:
          - 01_Pandem
          - 02_Samaikya_Bharati
          - 03_Rekkala_Enugu
          - 04_Parishubhrata
          - 05_Nirmal_Bommalu
          - 06_Shataka_Padyalu
          - 07_Sankranthi_Sandesham
          - 08_Kanuvippu
          - 09_Ramappa
          - 10_Shibi_Chakravarti
      page_numbers:
        description: 'Page Numbers (Reference only)'
        required: false
        type: string
        default: 'N/A'

jobs:
  generate_exercises:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      - name: Generate Exercises HTML
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import sys
          from google import genai

          # ---------------- CONFIG ----------------
          CHAPTER = "${{ github.event.inputs.chapter_folder }}"
          API_KEY = os.environ.get("GEMINI_API_KEY")

          if not API_KEY:
              print("‚ùå GEMINI_API_KEY not set")
              sys.exit(1)

          MODEL_NAME = "models/gemini-1.5-flash"

          # ---------------- PATH RESOLUTION ----------------
          try:
              chapter_num = int(CHAPTER.split("_")[0])
          except:
              print("‚ùå Invalid chapter folder naming")
              sys.exit(1)

          md_path = f"class5/{CHAPTER}/exercise_{chapter_num}.md"
          output_path = f"class5/{CHAPTER}/exercise.html"

          if not os.path.exists(md_path):
              print(f"‚ùå Source file not found: {md_path}")
              sys.exit(1)

          with open(md_path, "r", encoding="utf-8") as f:
              exercise_text = f.read()

          # ---------------- GEMINI CLIENT ----------------
          client = genai.Client(api_key=API_KEY)

          prompt = f"""
          You are an expert Telugu language tutor for Class 5 students.

          RAW OCR TEXT (Exercises):
          {exercise_text}

          TASK:
          1. Extract all questions.
          2. Correct OCR mistakes intelligently.
          3. Generate correct answers where needed.

          OUTPUT:
          Return ONLY raw HTML body content.

          STRUCTURE:
          - Each Q&A inside <div class="card mb-4 shadow-sm">
          - Question block: alert alert-info
          - Answer block: alert alert-success
          - Telugu + Pronunciation + English Meaning for both
          """

          try:
              response = client.models.generate_content(
                  model=MODEL_NAME,
                  contents=prompt
              )
          except Exception as e:
              if "RESOURCE_EXHAUSTED" in str(e):
                  print("‚ùå Gemini quota exhausted. Enable billing or increase quota.")
                  sys.exit(1)
              print(f"‚ùå Gemini error: {e}")
              sys.exit(1)

          output_html = response.text.strip()

          if "```" in output_html:
              output_html = output_html.split("```")[1]

          final_html = f"""
          <!DOCTYPE html>
          <html lang="te">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{CHAPTER.replace("_", " ")} - Exercises</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <style>
                  body {{
                      background-color: #f0f2f5;
                      font-family: 'Segoe UI', sans-serif;
                      padding: 20px;
                  }}
                  .exercise-title {{
                      background: linear-gradient(135deg, #0d6efd, #0dcaf0);
                      color: white;
                      border-radius: 12px;
                      padding: 20px;
                      margin-bottom: 30px;
                      text-align: center;
                  }}
                  .alert {{
                      word-break: break-word;
                      white-space: normal;
                  }}
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="exercise-title">
                      <h2>üìò Exercises</h2>
                  </div>
                  {output_html}
              </div>
          </body>
          </html>
          """

          with open(output_path, "w", encoding="utf-8") as f:
              f.write(final_html)

          print(f"‚úÖ Successfully generated {output_path}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Generate exercise.html for ${{ github.event.inputs.chapter_folder }}"
          git push
